pipeline {
    agent any
    
    stages {
    
        stage('Empty S3 Bucket') {
            steps {
                script {
                // Execute AWS CLI command to delete each object in the bucket
                sh '''
                    # List objects in the bucket and delete them one by one
                    aws s3api list-objects --bucket proj3-tf-bucket --query "Contents[].Key" --output text | while IFS= read -r key; do
                        aws s3api delete-object --bucket proj3-tf-bucket --key "$key"
                    done
                '''
                }
            }
        }

        stage ('Terraform Destroy') {
            steps {
                dir('/var/jenkins_home/workspace/proj3_job_s3/terraform_project/modules/s3_bucket') {
                    sh 'terraform destroy --auto-approve'
                }
            }
        }
    }
}